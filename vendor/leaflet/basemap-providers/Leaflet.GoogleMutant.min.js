L.GridLayer.GoogleMutant=L.GridLayer.extend({options:{minZoom:0,maxZoom:23,tileSize:256,subdomains:"abc",errorTileUrl:"",attribution:"",opacity:1,continuousWorld:!1,noWrap:!1,type:"roadmap",maxNativeZoom:21},initialize:function(a){L.GridLayer.prototype.initialize.call(this,a);this._GAPIPromise=(this._ready=!!window.google&&!!window.google.maps&&!!window.google.maps.Map)?Promise.resolve(window.google):new Promise(function(a,c){var d=0,e=null,e=setInterval(function(){if(10<=d)return clearInterval(e),
c(Error("window.google not found after 10 attempts"));if(window.google&&window.google.maps&&window.google.maps.Map)return clearInterval(e),a(window.google);d++},500)});this._tileCallbacks={};this._freshTiles={};this._imagesPerTile="hybrid"===this.options.type?2:1;this._boundOnMutatedImage=this._onMutatedImage.bind(this)},onAdd:function(a){L.GridLayer.prototype.onAdd.call(this,a);this._initMutantContainer();this._GAPIPromise.then(function(){this._ready=!0;this._map=a;this._initMutant();a.on("viewreset",
this._reset,this);a.on("move",this._update,this);a.on("zoomend",this._handleZoomAnim,this);a.on("resize",this._resize,this);google.maps.event.addListenerOnce(this._mutant,"idle",function(){this._checkZoomLevels();this._mutantIsReady=!0}.bind(this));a._controlCorners.bottomright.style.marginBottom="20px";a._controlCorners.bottomleft.style.marginBottom="20px";this._reset();this._update();if(this._subLayers)for(var b in this._subLayers)this._subLayers[b].setMap(this._mutant)}.bind(this))},onRemove:function(a){L.GridLayer.prototype.onRemove.call(this,
a);a._container.removeChild(this._mutantContainer);this._mutantContainer=void 0;google.maps.event.clearListeners(a,"idle");google.maps.event.clearListeners(this._mutant,"idle");a.off("viewreset",this._reset,this);a.off("move",this._update,this);a.off("zoomend",this._handleZoomAnim,this);a.off("resize",this._resize,this);a._controlCorners&&(a._controlCorners.bottomright.style.marginBottom="0em",a._controlCorners.bottomleft.style.marginBottom="0em")},getAttribution:function(){return this.options.attribution},
setOpacity:function(a){this.options.opacity=a;1>a&&L.DomUtil.setOpacity(this._mutantContainer,a)},setElementSize:function(a,b){a.style.width=b.x+"px";a.style.height=b.y+"px"},addGoogleLayer:function(a,b){this._subLayers||(this._subLayers={});return this._GAPIPromise.then(function(){var c=new google.maps[a](b);c.setMap(this._mutant);return this._subLayers[a]=c}.bind(this))},removeGoogleLayer:function(a){var b=this._subLayers&&this._subLayers[a];b&&(b.setMap(null),delete this._subLayers[a])},_initMutantContainer:function(){this._mutantContainer||
(this._mutantContainer=L.DomUtil.create("div","leaflet-google-mutant leaflet-top leaflet-left"),this._mutantContainer.id="_MutantContainer_"+L.Util.stamp(this._mutantContainer),this._mutantContainer.style.zIndex="800",this._mutantContainer.style.pointerEvents="none",this._map.getContainer().appendChild(this._mutantContainer));this.setOpacity(this.options.opacity);this.setElementSize(this._mutantContainer,this._map.getSize());this._attachObserver(this._mutantContainer)},_initMutant:function(){if(this._ready&&
this._mutantContainer){this._mutantCenter=new google.maps.LatLng(0,0);var a=new google.maps.Map(this._mutantContainer,{center:this._mutantCenter,zoom:0,tilt:0,mapTypeId:this.options.type,disableDefaultUI:!0,keyboardShortcuts:!1,draggable:!1,disableDoubleClickZoom:!0,scrollwheel:!1,streetViewControl:!1,styles:this.options.styles||{},backgroundColor:"transparent"});this._mutant=a;google.maps.event.addListenerOnce(a,"idle",function(){for(var a=this._mutantContainer.querySelectorAll("a"),c=0;c<a.length;c++)a[c].style.pointerEvents=
"auto"}.bind(this));this.fire("spawned",{mapObject:a})}},_attachObserver:function(a){(new MutationObserver(this._onMutations.bind(this))).observe(a,{childList:!0,subtree:!0})},_onMutations:function(a){for(var b=0;b<a.length;++b)for(var c=a[b],d=0;d<c.addedNodes.length;++d){var e=c.addedNodes[d];e instanceof HTMLImageElement?this._onMutatedImage(e):e instanceof HTMLElement&&(Array.prototype.forEach.call(e.querySelectorAll("img"),this._boundOnMutatedImage),Array.prototype.forEach.call(e.querySelectorAll('div[draggable=false][style*="text-align: center"]'),
L.DomUtil.remove))}},_roadRegexp:/!1i(\d+)!2i(\d+)!3i(\d+)!/,_satRegexp:/x=(\d+)&y=(\d+)&z=(\d+)/,_staticRegExp:/StaticMapService\.GetMapImage/,_onMutatedImage:function(a){var b,c=a.src.match(this._roadRegexp),d=0;c?(b={z:c[1],x:c[2],y:c[3]},1<this._imagesPerTile&&(d=a.style.zIndex=1)):((c=a.src.match(this._satRegexp))&&(b={x:c[1],y:c[2],z:c[3]}),d=0);b?(b=this._tileCoordsToKey(b),a.style.position="absolute",a.style.visibility="hidden",c=b+"/"+d,this._freshTiles[c]=a,c in this._tileCallbacks&&this._tileCallbacks[c]?
(this._tileCallbacks[c].pop()(a),this._tileCallbacks[c].length||delete this._tileCallbacks[c]):this._tiles[b]&&(b=this._tiles[b].el,d=0===d?b.firstChild:b.firstChild.nextSibling,a=this._clone(a),b.replaceChild(a,d))):a.src.match(this._staticRegExp)&&(a.style.visibility="hidden")},createTile:function(a,b){var c=this._tileCoordsToKey(a),d=L.DomUtil.create("div");d.dataset.pending=this._imagesPerTile;b=b.bind(this,null,d);for(var e=0;e<this._imagesPerTile;e++){var f=c+"/"+e;f in this._freshTiles?(d.appendChild(this._clone(this._freshTiles[f])),
d.dataset.pending--):(this._tileCallbacks[f]=this._tileCallbacks[f]||[],this._tileCallbacks[f].push(function(a){return function(c){a.appendChild(this._clone(c));a.dataset.pending--;parseInt(a.dataset.pending)||b()}.bind(this)}.call(this,d)))}parseInt(d.dataset.pending)||L.Util.requestAnimFrame(b);return d},_clone:function(a){a=a.cloneNode(!0);a.style.visibility="visible";return a},_checkZoomLevels:function(){var a=this._map.getZoom(),b=this._mutant.getZoom();a&&b&&(b!==a||b>this.options.maxNativeZoom)&&
this._setMaxNativeZoom(b)},_setMaxNativeZoom:function(a){a!=this.options.maxNativeZoom&&(this.options.maxNativeZoom=a,this._resetView())},_reset:function(){this._initContainer()},_update:function(){if(this._mutant){var a=this._map.getCenter(),a=new google.maps.LatLng(a.lat,a.lng);this._mutant.setCenter(a);var a=this._map.getZoom(),b=a!==Math.round(a),c=this._mutant.getZoom();b||a==c||(this._mutant.setZoom(a),this._mutantIsReady&&this._checkZoomLevels())}L.GridLayer.prototype._update.call(this)},_resize:function(){var a=
this._map.getSize();if(this._mutantContainer.style.width!==a.x||this._mutantContainer.style.height!==a.y)this.setElementSize(this._mutantContainer,a),this._mutant&&google.maps.event.trigger(this._mutant,"resize")},_handleZoomAnim:function(){if(this._mutant){var a=this._map.getCenter(),a=new google.maps.LatLng(a.lat,a.lng);this._mutant.setCenter(a);this._mutant.setZoom(Math.round(this._map.getZoom()))}},_removeTile:function(a){if(this._mutant)return setTimeout(this._pruneTile.bind(this,a),1E3),L.GridLayer.prototype._removeTile.call(this,
a)},_pruneTile:function(a){for(var b=this._mutant.getZoom(),c=a.split(":")[2],d=this._mutant.getBounds(),e=d.getSouthWest(),d=d.getNorthEast(),e=L.latLngBounds([[e.lat(),e.lng()],[d.lat(),d.lng()]]),d=0;d<this._imagesPerTile;d++){var f=a+"/"+d;if(f in this._freshTiles){var g=this._map&&this._keyToBounds(a);this._map&&g.overlaps(e)&&c==b||delete this._freshTiles[f]}}}});L.gridLayer.googleMutant=function(a){return new L.GridLayer.GoogleMutant(a)};
